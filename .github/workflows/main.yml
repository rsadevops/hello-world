name: Versioning

on:
  push:
    branches:
      - main

jobs:
  versioning:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Fetch tags
        run: git fetch --tags
        
      - name: Get latest tag
        id: latest_tag
        run: |
          echo "::set-output name=tag::$(git describe --tags --abbrev=0 --always)"
      
      - name: Determine new version
        id: new_version
        run: |
          latest_tag="${{ steps.latest_tag.outputs.tag }}"
          major=$(echo $latest_tag | awk -F. '{print $1}')
          minor=$(echo $latest_tag | awk -F. '{print $2}')
          patch=$(echo $latest_tag | awk -F. '{print $3}')
          commit_messages=$(git log $latest_tag..HEAD --pretty=format:"%s")
          
          if echo "$commit_messages" | grep -qE '^feat:'; then
            minor=$((minor + 1))
            patch=0
          elif echo "$commit_messages" | grep -qE '^fix:'; then
            patch=$((patch + 1))
          else
            patch=$((patch + 1))
          fi
          
          new_version="$major.$minor.$patch"
          echo "::set-output name=version::$new_version"
        
      - name: Set outputs
        id: outputs
        run: |
          echo "::set-output name=version::${{ steps.new_version.outputs.version }}"
          echo "::set-output name=tag::${{ steps.latest_tag.outputs.tag }}"
          
      - name: Use the new version
        run: |
          echo "New version: ${{ steps.outputs.outputs.version }}"
          echo "Latest tag: ${{ steps.outputs.outputs.tag }}"
          
          # Use the new version for further actions or steps


